<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>USAT CALCULATOR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="assets/img/usat_logo_red.jpg" type="image">
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <!-- html2canvas CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="css/style.css" rel="stylesheet">
    <link rel="manifest" href="manifest.webmanifest">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
    <script>
        // Theme toggle logic
        function setTheme(theme) {
            if (theme === 'auto') {
                document.body.removeAttribute('data-theme');
                sessionStorage.setItem('theme', 'auto');
            } else {
                document.body.setAttribute('data-theme', theme);
                sessionStorage.setItem('theme', theme);
            }
        }

        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyThemeOnLoad() {
            let theme = sessionStorage.getItem('theme') || 'auto';
            if (theme === 'auto') {
                // Detecta el tema del sistema y lo aplica visualmente
                const systemTheme = getSystemTheme();
                document.body.setAttribute('data-theme', systemTheme);
            } else {
                document.body.setAttribute('data-theme', theme);
            }
            // Actualiza el select visualmente
            var select = document.getElementById('theme-select');
            if (select) select.value = theme;
        }

        // Escucha cambios en el sistema y actualiza si está en auto
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function () {
            if ((sessionStorage.getItem('theme') || 'auto') === 'auto') {
                applyThemeOnLoad();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            applyThemeOnLoad();
            // Toggle event
            $(document).on('change', '#theme-select', function () {
                setTheme(this.value);
                applyThemeOnLoad();
            });
        });
    </script>
</head>

<body>

    <div class="container py-5">
        <h2 class="text-center mb-4">
            <img src="assets/img/usat_logo.png" id="logo_usat" alt="logo" style="width: 90px;">
            GENERADOR DE CALCULADORA DE PROMEDIO
        </h2>

        <div class="card p-4 shadow-lg bg-light text-dark" style="border: none; position: relative; overflow: visible;">
            <div class="d-flex flex-column align-items-center justify-content-center" style="gap: 1.2rem;">
                <div style="position: relative;">
                    <div id="upload-anim-icon"
                        style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); pointer-events: none; transition: color 0.3s; z-index:3;">
                        <i class="bi bi-cloud-arrow-up-fill"
                            style="font-size: 3.5rem; color: #d9534f; opacity: 0.7; transition: color 0.3s;"></i>
                    </div>
                    <input type="file" class="form-control mb-3" id="pdfFile" accept="application/pdf"
                        style="opacity:0; width: 120px; height: 120px; cursor:pointer; position: absolute; left:0; top:0; z-index:4;" />
                    <div id="custom-upload-area"
                        style="width: 120px; height: 120px; border: 2.5px dashed #d9534f; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #fff; cursor: pointer; transition: border-color 0.3s, box-shadow 0.3s; z-index:2; position:relative;">
                    </div>
                    <div id="upload-loading"
                        style="display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:5;">
                        <div class="spinner-border text-warning" style="width:2.5rem; height:2.5rem;"></div>
                    </div>
                </div>
                <div id="file-name-area"
                    style="min-height: 1.5em; font-size: 1em; color: #333; font-weight: 500; text-align: center;"></div>
                <label for="pdfFile" class="form-label text-center"
                    style="font-size: 1.1em; color: #900; font-weight: bold; cursor:pointer;">Sube tu sílabo del
                    curso<br><span style="font-size:0.95em; color:#555; font-weight:normal;">(PDF, arrastra o haz clic
                        en el círculo)</span></label>
                <button id="btn-generar-calc" class="btn btn-danger w-100"
                    style="font-weight:bold; font-size:1.1em; transition: box-shadow 0.3s, transform 0.3s;">
                    <i class="bi bi-file-earmark-text"></i> Generar Calculadora
                </button>
                <button id="btn-minimas-necesarias" class="btn btn-warning mb-3"><i class="bi bi-calculator"></i> ¿Qué
                    nota necesito para aprobar?</button>
            </div>
        </div>
    </div>

    <div class="container" id="body-content">

    </div>

    <div class="theme-toggle">
        <label for="theme-select" class="me-1 mb-0"><i class="bi bi-moon-stars"></i></label>
        <select id="theme-select" class="form-select form-select-sm" style="width: auto; display: inline-block;">
            <option value="auto">Auto</option>
            <option value="light">Claro</option>
            <option value="dark">Oscuro</option>
        </select>
    </div>

    <a href="https://wa.me/51960920160" target="_blank" id="whatsapp-fab" title="Contáctanos por WhatsApp">
        <i class="bi bi-whatsapp"></i>
    </a>
    <a href="https://drive.google.com/drive/folders/1Lzg2q3Um052I1FWKWakhmhl6f9iHhE9f?usp=sharing" target="_blank"
        id="drive-fab" title="Sube tu sílabo a Google Drive"
        class="btn btn-warning d-flex align-items-center justify-content-center">
        <i class="fab fa-google-drive" style="font-size: 2.3rem;"></i>
        <span style="font-size:1.1rem;font-weight:bold;"></span>
    </a>
    <style>
        #whatsapp-fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            z-index: 99999;
            width: 64px;
            height: 64px;
            background: #25d366;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);
            font-size: 2.3rem;
            transition: box-shadow 0.2s, transform 0.2s;
            text-decoration: none;
            border: none;
        }

        #whatsapp-fab:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.28);
            transform: scale(1.08);
            color: #fff;
            background: #1ebe57;
        }

        #drive-fab {
            position: fixed;
            bottom: 110px;
            right: 32px;
            z-index: 99999;
            width: 64px;
            height: 64px;
            background: #ffc107;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);

            transition: box-shadow 0.2s, transform 0.2s;
            text-decoration: none;
            border: none;
        }

        #drive-fab:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.28);
            transform: scale(1.08);
            color: #fff;
            background: #e0a800;
        }

        .dragover {
            border-color: #f7b731 !important;
            box-shadow: 0 0 16px 2px rgba(247, 183, 49, 0.3) !important;
        }

        .success {
            border-color: #28a745 !important;
            background-color: rgba(40, 167, 69, 0.1) !important;
        }

        .error {
            border-color: #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.1) !important;
        }

        .drag-anim {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            border-radius: 50%;
            pointer-events: none;
            animation: wave-animation 1.2s linear infinite;
            z-index: 1;
        }

        @keyframes wave-animation {
            0% {
                transform: scale(0.9);
                opacity: 1;
            }

            100% {
                transform: scale(1.1);
                opacity: 0;
            }
        }
    </style>
    <script src="js/app.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        function setUploadStatus(status) {
            // status: 'success', 'error', 'idle'
            let iconHtml = '';
            if (status === 'success') iconHtml = '<i class="bi bi-check-circle-fill" style="font-size:3.5rem;color:#28a745;background:#fff;border-radius:50%;box-shadow:0 0 0 6px #fff;"></i>';
            else if (status === 'error') iconHtml = '<i class="bi bi-x-circle-fill" style="font-size:3.5rem;color:#dc3545;background:#fff;border-radius:50%;box-shadow:0 0 0 6px #fff;"></i>';
            else iconHtml = '<i class="bi bi-cloud-arrow-up-fill" style="font-size:3.5rem;color:#d9534f;opacity:0.7;"></i>';
            $('#upload-anim-icon').html(iconHtml);
        }
        // Efecto visual al arrastrar archivo
        $(document).on('dragover', '#custom-upload-area', function (e) {
            e.preventDefault();
            $(this).addClass('dragover');
            if ($(this).find('.drag-anim').length === 0) {
                $(this).append('<div class="drag-anim"></div>');
            }
            $('#upload-anim-icon i').css('color', '#f7b731');
        });
        $(document).on('dragleave drop', '#custom-upload-area', function (e) {
            e.preventDefault();
            $(this).removeClass('dragover');
            setTimeout(function () { $('#custom-upload-area .drag-anim').remove(); }, 300);
            $(this).removeClass('success error');
            $(this).css({ 'border-color': '', 'box-shadow': '' });
            setUploadStatus('idle');
        });
        // Detectar cuando el usuario está sosteniendo un archivo sobre la ventana
        $(window).on('dragenter', function (e) {
            // Solo si hay archivos
            if (e.originalEvent && e.originalEvent.dataTransfer && e.originalEvent.dataTransfer.types && e.originalEvent.dataTransfer.types.includes('Files')) {
                $('#custom-upload-area').addClass('dragover');
                if ($('#custom-upload-area .drag-anim').length === 0) {
                    $('#custom-upload-area').append('<div class="drag-anim"></div>');
                }
            }
        });
        $(window).on('dragleave drop', function (e) {
            $('#custom-upload-area').removeClass('dragover');
            setTimeout(function () { $('#custom_upload_area .drag-anim').remove(); }, 300);
        });
        // Drop directo sobre el área
        $(document).on('drop', '#custom-upload-area', function (e) {
            e.preventDefault();
            const files = e.originalEvent.dataTransfer.files;
            $(this).removeClass('dragover');
            setTimeout(function () { $('#custom-upload-area .drag-anim').remove(); }, 300);
            if (files.length > 0 && files[0].type === 'application/pdf') {
                $('#pdfFile')[0].files = files;
                $('#custom-upload-area').addClass('success').removeClass('error');
                $('#custom-upload-area').html('');
                $('#upload-loading').show();
                setTimeout(function () {
                    $('#upload-loading').hide();
                    setUploadStatus('success');
                    $('#file-name-area').html('<span style="color:#28a745;">' + files[0].name + '</span>');
                    $('#btn-generar-calc').css({ 'box-shadow': '0 0 0 4px #f7b73199', 'transform': 'scale(1.05)' });
                    setTimeout(function () {
                        $('#btn-generar-calc').css({ 'box-shadow': '', 'transform': '' });
                    }, 1200);
                }, 900);
            } else {
                $('#custom-upload-area').addClass('error').removeClass('success');
                setUploadStatus('error');
                $('#file-name-area').html('<span style="color:#dc3545;">Archivo no válido. Sube un PDF.</span>');
            }
        });
        // Click en el área personalizada abre el input
        $(document).on('click', '#custom-upload-area', function () {
            $('#pdfFile').trigger('click');
        });
        // Mostrar nombre del archivo seleccionado y animación
        $(document).on('change', '#pdfFile', function () {
            if (this.files && this.files[0] && this.files[0].type === 'application/pdf') {
                $('#custom-upload-area').html('');
                $('#upload-loading').show();
                setTimeout(function () {
                    $('#upload-loading').hide();
                    setUploadStatus('success');
                    $('#file-name-area').html('<span style="color:#28a745;">' + $('#pdfFile')[0].files[0].name + '</span>');
                    // Enfatizar el botón
                    $('#btn-generar-calc').css({ 'box-shadow': '0 0 0 4px #f7b73199', 'transform': 'scale(1.05)' });
                    setTimeout(function () {
                        $('#btn-generar-calc').css({ 'box-shadow': '', 'transform': '' });
                    }, 1200);
                }, 900);
            } else {
                setUploadStatus('error');
                $('#file-name-area').html('<span style="color:#dc3545;">Archivo no válido. Sube un PDF.</span>');
            }
        });
        // Mostrar el ícono correcto al cargar la página
        $(function () { setUploadStatus('idle'); });
        // Mostrar modal de ayuda al usuario para subir su sílabo
        Swal.fire({
            title: '¡Ayúdanos a mejorar!',
            html: '<div style="display:flex;align-items:center;gap:10px;justify-content:center;">' +
                '<img src="https://justificaturespuesta.com/wp-content/uploads/2014/03/Google-Drive.png" alt="Google Drive" style="width:36px;height:36px;vertical-align:middle;">' +
                '<span>Sube tus sílabos a este drive:</span>' +
                '</div>' +
                '<a href="https://drive.google.com/drive/folders/1Lzg2q3Um052I1FWKWakhmhl6f9iHhE9f?usp=sharing" target="_blank" style="color:#d9534f;font-weight:bold;display:block;margin-top:10px;">Ir a Google Drive</a>',
            icon: 'info',
            confirmButtonText: 'Cerrar',
            allowOutsideClick: false,
            showCloseButton: true,
            timer: undefined,
            timerProgressBar: false,
            willClose: () => false
        });
        $(document).on('click', '#drive-fab', function (e) {
            e.preventDefault();
            Swal.fire({
                title: '¿Quieres contribuir con tus sílabos?',
                html: '<div style="display:flex;align-items:center;gap:10px;justify-content:center;">' +
                    '<img src="https://justificaturespuesta.com/wp-content/uploads/2014/03/Google-Drive.png" alt="Google Drive" style="width:36px;height:36px;vertical-align:middle;">' +
                    '<span>Ayúdanos a mejorar la calculadora subiendo tus sílabos de este semestre a nuestro Google Drive. ¡Tu aporte es valioso!</span>' +
                    '</div>',
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Ir a Drive',
                cancelButtonText: 'Cerrar',
                allowOutsideClick: true,
                showCloseButton: true
            }).then((result) => {
                if (result.isConfirmed) {
                    window.open('https://drive.google.com/drive/folders/1Lzg2q3Um052I1FWKWakhmhl6f9iHhE9f?usp=sharing', '_blank');
                }
            });
        });
        $(document).ready(function () {
            if (!localStorage.getItem('changelog_v1.1_shown')) {
                Swal.fire({
                    title: 'Novedades de la versión 1.1',
                    html: `<ul style="text-align:left;">
                                <li>Las notas ahora se ajustan automáticamente a 0 si son menores a 0 y a 20 si son mayores a 20.</li>
                                <li>Mejoras visuales y de experiencia de usuario.</li>
                                <li>Corrección de validaciones en los campos de nota.</li>
                            </ul>`,
                    icon: 'info',
                    confirmButtonText: '¡Entendido!',
                    customClass: {
                        popup: 'swal2-popup-custom',
                        title: 'swal2-title-custom',
                        htmlContainer: 'swal2-html-custom'
                    }
                });
                localStorage.setItem('changelog_v1.1_shown', 'true');
            }
            else if (!localStorage.getItem('changelog_v1.2_shown')) {
                Swal.fire({
                    title: 'Novedades de la versión 1.2',
                    html: `<ul style="text-align:left;">
                                <li>Se agregó la opción de ver el historial de notas.</li>
                                <li>Mejoras en la velocidad de carga de la calculadora.</li>
                                <li>Corrección de errores menores.</li>
                            </ul>`,
                    icon: 'info',
                    confirmButtonText: '¡Entendido!',
                    customClass: {
                        popup: 'swal2-popup-custom',
                        title: 'swal2-title-custom',
                        htmlContainer: 'swal2-html-custom'
                    }
                });
                localStorage.setItem('changelog_v1.2_shown', 'true');
            }
        });
    </script>

</body>

</html>